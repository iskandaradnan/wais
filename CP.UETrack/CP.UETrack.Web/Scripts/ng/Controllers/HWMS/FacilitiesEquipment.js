$(document).ready(function () {
    $.get("/api/FacilitiesEquipment/Load")
        .done(function (result) {
            var loadResult = JSON.parse(result);
            $("#ddlItemType").append("<option value='' Selected>" + "Select" + "</option>");

            for (var i = 0; i < loadResult.FacilitiesStatusLovs.length; i++) {
                $("#ddlStatus").append(
                    "<option value=" + loadResult.FacilitiesStatusLovs[i].LovId + ">" + loadResult.FacilitiesStatusLovs[i].FieldValue + "</option>"
                );
            }
            for (var i = 0; i < loadResult.ItemTypesLovs.length-1; i++) {
                $("#ddlItemType").append(
                    "<option value=" + loadResult.ItemTypesLovs[i].LovId + ">" + loadResult.ItemTypesLovs[i].FieldValue + "</option>"
                );
            }
            $('#myPleaseWait').modal('hide');
        })
        .fail(function (response) {
            $('#myPleaseWait').modal('hide');
            $("div.errormsgcenter").text(Messages.COMMON_FAILURE_MESSAGE(response));
            $('#errorMsgConfigAdditionalFields').css('visibility', 'visible');
        });

    autoGeneratedCode();
   
    $("#btnSave, #btnSaveandAddNew").click(function () {

        $("div.errormsgcenter").text("");
        var CurrentbtnID = $(this).attr("Id");
        $('#errorMsg').css('visibility', 'hidden');

        var isFormValid = formInputValidation("formFetc", 'save');

        if (!isFormValid) {

            $("div.errormsgcenter").text(Messages.INVALID_INPUT_MESSAGE);
            $('#errorMsg').css('visibility', 'visible');
            return false;
        }

        var FacilitiesEquipment = {

            FetcId: $("#primaryID").val(),
            CustomerId: $('#selCustomerLayout').val(),
            FacilityId: $('#selFacilityLayout').val(),
            ItemCode: $('#txtItemCode').val(),
            ItemDescription: $('#txtItemDescription').val(),
            ItemType: $('#ddlItemType').val(),
            EffectiveFrom: $('#txtEffectiveFrom').val(),
            EffectiveTo: $('#txtEffectiveTo').val(),

            Status: $("#ddlStatus option:selected").val()
        };
        var jqxhr = $.post("/Api/FacilitiesEquipment/Save", FacilitiesEquipment, function (response) {

            showMessage('FacilitiesEquipment', CURD_MESSAGE_STATUS.SS);
            $("#grid").trigger('reloadGrid');
            autoGeneratedCode();
            if (CurrentbtnID == "btnSaveandAddNew") {
                EmptyFields();
            }
            var result = JSON.parse(response);
           
            $("#primaryID").val(result.FetcId);

            
            if (result.FetcId != 0) {
                $('#hdnAttachId').val(result.HiddenId);
                $('#blockCode').prop('disabled', true);
                $('#btnNextScreenSave').show();
                $('#btnEdit').show();
                $('#btnSave').hide();
                $('#btnDelete').show();
            }
            
        },
            "json")
            .fail(function (response) {

                var errorMessage = "";
                if (response.status == 400) {
                    errorMessage = response.responseJSON;
                }
                else {
                    errorMessage = Messages.COMMON_FAILURE_MESSAGE(response);
                }
                $("div.errormsgcenter").text(errorMessage);
                $('#errorMsg').css('visibility', 'visible');

                $('#btnSave').attr('disabled', false);

            });

    });

    //Reset Button Code....

    $("#btnCancel").click(function () {
        var message = Messages.Reset_Alert_CONFIRMATION;
        bootbox.confirm(message, function (result) {
            if (result) {
                EmptyFields();
            }
            else {
                $('#myPleaseWait').modal('hide');
            }
        });
    });
    $("#ddlStatus").change(function () {

        var StateValue = $('#ddlStatus option:selected').text();
        if (StateValue == 'Active') {
            $('#txtEffectiveTo').val("");
        }
        else {
            var val = "";
            var date = new Date();
            var months = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL",
                "AUG", "SEP", "OCT", "NOV", "DEC"];
            var val = date.getDate() + " " + months[date.getMonth()] + " " + date.getFullYear();
            $("#txtEffectiveTo").val(val);
        }

    });

    $('#txtItemDescription').keypress('change', function () {

        $('#formFetc #description').removeClass('has-error');
    });
    $('#ddlItemType').on('change', function () {

        $('#formFetc #type').removeClass('has-error');
    });
    $('#txtEffectiveFrom').change(function () {

        $('#formFetc #effect').removeClass('has-error');

        $('#errorMsg').css('visibility', 'hidden');
    });

    var getUrlParameter = function getUrlParameter(sParam) {
        var sPageURL = decodeURIComponent(window.location.search.substring(1)),
            sURLVariables = sPageURL.split('&'),
            sParameterName,
            i;

        for (i = 0; i < sURLVariables.length; i++) {
            sParameterName = sURLVariables[i].split('=');

            if (sParameterName[0] === sParam) {
                return sParameterName[1] === undefined ? true : sParameterName[1];
            }
        }
    };
    var ID = getUrlParameter('id');
    if (ID == null || ID == undefined || ID == 0 || ID == '' || ID == "") {
        $("#jQGridCollapse1").click();
    }
    else {
        LinkClicked(ID);
    }

});

function LinkClicked(id) {
    $(".content").scrollTop(1);
    $('.nav-tabs a:first').tab('show');
    $("#formFetc :input:not(:button)").parent().removeClass('has-error');
    $("div.errormsgcenter").text("");
    $('#errorMsg').css('visibility', 'hidden');
    var action = "";
    $('#primaryID').val(id);
    var hasEditPermission = Enumerable.From(JSON.parse($('#ActionPermissionValues').val())).Any("$.ActionPermissionName=='Edit'");
    var hasViewPermission = Enumerable.From(JSON.parse($('#ActionPermissionValues').val())).Any("$.ActionPermissionName=='View'");
    var hasDeletePermission = Enumerable.From(JSON.parse($('#ActionPermissionValues').val())).Any("$.ActionPermissionName=='Delete'");

    if (hasEditPermission) {
        action = "Edit"

    }
    else if (!hasEditPermission && hasViewPermission) {
        action = "View"
    }
    if (action == "Edit" && hasDeletePermission) {
        $('#btnDelete').show();
    }

    if (action == 'View') {
        $("#formFetc :input:not(:button)").prop("disabled", true);
    } else {
        $('#btnEdit').show();
        //$('#btnSave').hide();
        //$('#btnSaveandAddNew').hide();
        $('#btnNextScreenSave').show();
    }
    $('#spnActionType').text(action);

    var primaryId = $('#primaryID').val();
    if (primaryId != null && primaryId != "0") {
        $.get("/api/FacilitiesEquipment/Get/" + primaryId)
            .done(function (result) {
                var getResult = JSON.parse(result);
                $('#txtItemCode').val(getResult.ItemCode);
                $('#txtItemDescription').val(getResult.ItemDescription);
                //$('#SelStatus option[value="' + getResult.Active + '"]').prop('selected', true);
                $('#ddlItemType').val(getResult.ItemType);
                $('#ddlStatus').val(getResult.Status);
                $('#txtEffectiveFrom').val(getResult.EffectiveFrom);

                var date = $('#txtEffectiveFrom').val();
                var d1 = date.slice(0, 10);
                var year = d1.slice(0, 4);
                var month = d1.slice(5, 7);
                var datee = d1.slice(8, 10);
                var dataformate = datee + "-" + "Oct" + "-" + year;
                $('#txtEffectiveFrom').val(dataformate);

                if (getResult.EffectiveTo != null) {
                    $('#txtEffectiveTo').val(getResult.EffectiveTo);
                    var date1 = $('#txtEffectiveTo').val();
                    var d2 = date1.slice(0, 10);
                    var year1 = d2.slice(0, 4);
                    var month = d2.slice(5, 7);
                    var datee2 = d2.slice(8, 10);
                    var dataformate2 = datee2 + "-" + "Oct" + "-" + year1;
                    $('#txtEffectiveTo').val(dataformate2);
                }
                else {
                    $('#txtEffectiveTo').val('');
                }
            })
            .fail(function () {
                $('#myPleaseWait').modal('hide');
                $("div.errormsgcenter").text(Messages.COMMON_FAILURE_MESSAGE);
                $('#errorMsg').css('visibility', 'visible');
            });
    }
    else {
        $('#myPleaseWait').modal('hide');

    }
}

function EmptyFields() {
    $('#primaryID').val('');

    $.get("/api/FacilitiesEquipment/AutoGenerateCode", obj, function (response) {

        var result = JSON.parse(response);
        var ItemCode = result.ItemCode;
        var Item1 = parseInt(ItemCode.slice(1, 4)) + 1;
        var Item2 = "";
        if (Item1.toString().length === 1) {
            Item2 = "00";
        } else if (Item1.toString().length === 2) {
            Item2 = "0";
        }
        var item3 = "C" + Item2 + Item1;
        $('#txtItemCode').val(item3);
    });

    $('#formFetc #txtItemDescription').val('');
    $('select').val('');
    $('#formFetc #txtEffectiveFrom').val('');
    $('#formFetc #ddlStatus').val('10400');
    $('#formFetc #txtEffectiveTo').val('');

    $('#description').removeClass('has-error');
    $('#type').removeClass('has-error');
    $('#effect').removeClass('has-error');
    $('#status').removeClass('has-error');

    $('#errorMsg').css('visibility', 'hidden');
}
function autoGeneratedCode() {
    var obj = {
        ItemCode: "CODE"
    }

    $.get("/api/FacilitiesEquipment/AutoGenerateCode", obj, function (response) {

        var result = JSON.parse(response);
        var ItemCode = result.ItemCode;
        var Item1 = parseInt(ItemCode.slice(1, 4)) + 1;
        var Item2 = "";
        if (Item1.toString().length === 1) {
            Item2 = "00";
        } else if (Item1.toString().length === 2) {
            Item2 = "0";
        }
        var item3 = "C" + Item2 + Item1;
        $('#txtItemCode').val(item3);
    });
}
$("#jQGridCollapse1").click(function () {
    var pro = new Promise(function (res, err) {
        $(".jqContainer").toggleClass("hide_container");
        res(1);
    })
    pro.then(
        function resposes() {
            setTimeout(() => $(".content").scrollTop(3000), 1);
        })
})